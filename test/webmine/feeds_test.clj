(ns webmine.feeds-test
  (:require [clj-time.core :as time])
  (:use clojure.test
        webmine.feeds
        webmine.urls))

(deftest is-link-an-rss-feed
  (is (not (good-rss? "http://www.foo.com" "")))
  (is (not (good-rss?
	    "http://www.foo.com/xmlrpc.php" "application+rss")))
  (is (good-rss? "http://www.foo.com/feed.xml"  "application+rss"))
  (is (not (good-rss? "http://www.foo.com/feed.html" ""))))

(deftest find-rss-feeds
  (is (= (set ["http://www.huffingtonpost.com/feeds/original_posts/index.xml"
               "http://feeds.huffingtonpost.com/FeaturedPosts"
               "http://feeds.huffingtonpost.com/huffingtonpost/raw_feed"
               "http://feeds.huffingtonpost.com/huffingtonpost/TheBlog"
               "http://feeds.huffingtonpost.com/huffingtonpost/LatestNews"
               "http://www.huffingtonpost.com/wires/full_index.rdf"])
         (set (host-rss-feeds (url "http://www.huffingtonpost.com"))))))

(deftest canonical-rss-feed
  (is (= "http://feeds.huffingtonpost.com/FeaturedPosts"
	 (canonical-feed (url "http://www.huffingtonpost.com"))))
  (is (= "http://feeds.huffingtonpost.com/FeaturedPosts"
	 (canonical-feed (url "http://www.huffingtonpost.com"))))
  (is (= "http://feedproxy.google.com/TechCrunch"
	 (canonical-feed "http://techcrunch.com/2010/11/20/no-palin-no-galin/")))
  (is (= nil
	 (canonical-feed "http://friendfeed.com/paul/6c012ca5/europe-web-of-debt")))
  (is (= "http://feeds.feedburner.com/ommalik"
       (canonical-feed "http://gigaom.com")))
  (is (= nil
	 (canonical-feed "http://friendfeed.com/paul/74dd00cc/is-anyone-energized-by-doing-email")))
  (is (= "http://feeds.feedburner.com/TodayIFoundOut"
	 (canonical-feed "http://www.todayifoundout.com/")))
  (is (= "http://www.npr.org/rss/rss.php?id=1009"
	 (canonical-feed "http://www.npr.org/2010/11/19/131450204/discontent-swells-in-hosni-mubarak-s-egypt"))))

(def good-tc
{:body "<p><img src=\"http://tctechcrunch.files.wordpress.com/2010/11/dashboard.jpg\" />Computer power management software company, <a href=\"http://www.1e.com/index.aspx\">1E</a> has released a new version of its marquee product, <a href=\"http://www.1e.com/softwareproducts/nightwatchman/index.aspx\">NightWatchman</a>.</p> <p>Like its predecessors, version 6.0, helps corporations manage their network of computers to optimize energy efficiency. It gives IT managers the ability to remotely power down computers and establish energy-saving settings (ie. automatic shutdown of desktops during the weekend).</p> <p>In the latest version, <a href=\"http://www.crunchbase.com/company/1e\">1E</a> has added three key features: a new web-based dashboard (to help managers oversee the entire company&#8217;s computer power usage), improved diagnostic tools to determine why a computer hasn&#8217;t properly powered down, and tariff calculations based on location.</p> <p>Given how the price of energy can fluctuate significantly on a region by region basis, the new location-based calculations will help companies more accurately assess how much they&#8217;re saving on energy usage. Energy efficiency as it relates to IT management is becoming an increasingly important field, and according to Gartner Research, in two years more than half of mid and large-sized businesses will centrally manage their desktops&#8217; energy consumption.</p> <p>Although the average NightWatchman PC only saves $36 a year in energy costs, those incremental savings yield significant sums in aggregate. Several of 1E&#8217;s clients are large corporations with massive IT operations, such as AT&amp;T, Ford and Dell. According to 1E, NightWatchman has 4.6 million licensed users around the world, a group that has collectively saved $530 million in energy costs.</p> <div class=\"cbw snap_nopreview\"><div class=\"cbw_header\"><script src=\"http://www.crunchbase.com/javascripts/widget.js\" type=\"text/javascript\"></script><div class=\"cbw_header_text\"><a href=\"http://www.crunchbase.com/\">CrunchBase Information</a></div></div><div class=\"cbw_content\"><div class=\"cbw_subheader\"><a href=\"http://www.crunchbase.com/company/1e\">1E</a></div><div class=\"cbw_subcontent\"><script src=\"http://www.crunchbase.com/cbw/company/1e.js\" type=\"text/javascript\"></script></div><div class=\"cbw_footer\">Information provided by <a href=\"http://www.crunchbase.com/\">CrunchBase</a></div></div></div> <br /> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gocomments/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/comments/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/godelicious/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/delicious/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gofacebook/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/facebook/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gotwitter/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/twitter/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gostumble/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/stumble/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/godigg/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/digg/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/goreddit/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/reddit/tctechcrunch.wordpress.com/238571/\" /></a> <img alt=\"\" border=\"0\" src=\"http://stats.wordpress.com/b.gif?host=techcrunch.com&amp;blog=11718616&amp;post=238571&amp;subd=tctechcrunch&amp;ref=&amp;feed=1\" width=\"1\" height=\"1\" /> <p><a href=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/0/da\"><img src=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/0/di\" border=\"0\" ismap=\"true\"></img></a><br/> <a href=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/1/da\"><img src=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/1/di\" border=\"0\" ismap=\"true\"></img></a></p><div class=\"feedflare\"> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:2mJPEYqXBVI\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=2mJPEYqXBVI\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:7Q72WNTAKBA\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=7Q72WNTAKBA\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:yIl2AUoC8zA\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=yIl2AUoC8zA\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:-BTjWOF_DHI\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?i=tEFtaTZo8jI:MRP7yJsevfA:-BTjWOF_DHI\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:D7DqB2pKExk\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?i=tEFtaTZo8jI:MRP7yJsevfA:D7DqB2pKExk\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:qj6IDK7rITs\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=qj6IDK7rITs\" border=\"0\"></img></a> </div><img src=\"http://feeds.feedburner.com/~r/Techcrunch/~4/tEFtaTZo8jI\" height=\"1\" width=\"1\"/>", :des "<img src=\"http://tctechcrunch.files.wordpress.com/2010/11/watchman.jpg\" />Computer power management software company, <a href=\"http://www.1e.com/index.aspx\">1E</a> has released a new version of its marquee product, <a href=\"http://www.1e.com/softwareproducts/nightwatchman/index.aspx\">NightWatchman</a>. Like its predecessors, version 6.0, helps corporations manage their network of computers to optimize energy efficiency. It gives IT managers the ability to remotely power down computers and establish energy-saving settings (ie. automatic shutdown of desktops during the weekend). In the latest version, <a href=\"http://www.crunchbase.com/company/1e\">1E</a> has added three key features.<img alt=\"\" border=\"0\" src=\"http://stats.wordpress.com/b.gif?host=techcrunch.com&amp;blog=11718616&amp;post=238571&amp;subd=tctechcrunch&amp;ref=&amp;feed=1\" width=\"1\" height=\"1\" />"})

(def bad-tc
{:body "<p><img src=\"http://tctechcrunch.files.wordpress.com/2010/11/dashboard.jpg\" />Computer power management software company, <a href=\"http://www.1e.com/index.aspx\">1E</a> has released a new version of its marquee product, <a href=\"http://www.1e.com/softwareproducts/nightwatchman/index.aspx\">NightWatchman</a>.</p> <p>Like its predecessors, version 6.0, helps corporations manage their network of computers to optimize energy efficiency. It gives IT managers the ability to remotely power down computers and establish energy-saving settings (ie. automatic shutdown of desktops during the weekend).</p> <p>In the latest version, <a href=\"http://www.crunchbase.com/company/1e\">1E</a> has added three key features: a new web-based dashboard (to help managers oversee the entire company&#8217;s computer power usage), improved diagnostic tools to determine why a computer hasn&#8217;t properly powered down, and tariff calculations based on location.</p> <p>Given how the price of energy can fluctuate significantly on a region by region basis, the new location-based calculations will help companies more accurately assess how much they&#8217;re saving on energy usage. Energy efficiency as it relates to IT management is becoming an increasingly important field, and according to Gartner Research, in two years more than half of mid and large-sized businesses will centrally manage their desktops&#8217; energy consumption.</p> <p>Although the average NightWatchman PC only saves $36 a year in energy costs, those incremental savings yield significant sums in aggregate. Several of 1E&#8217;s clients are large corporations with massive IT operations, such as AT&amp;T, Ford and Dell. According to 1E, NightWatchman has 4.6 million licensed users around the world, a group that has collectively saved $530 million in energy costs.</p> <div class=\"cbw snap_nopreview\"><div class=\"cbw_header\"><script src=\"http://www.crunchbase.com/javascripts/widget.js\" type=\"text/javascript\"></script><div class=\"cbw_header_text\"><a href=\"http://www.crunchbase.com/\">CrunchBase Information</a></div></div><div class=\"cbw_content\"><div class=\"cbw_subheader\"><a href=\"http://www.crunchbase.com/company/1e\">1E</a></div><div class=\"cbw_subcontent\"><script src=\"http://www.crunchbase.com/cbw/company/1e.js\" type=\"text/javascript\"></script></div><div class=\"cbw_footer\">Information provided by <a href=\"http://www.crunchbase.com/\">CrunchBase</a></div></div></div> <br /> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gocomments/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/comments/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/godelicious/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/delicious/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gofacebook/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/facebook/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gotwitter/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/twitter/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/gostumble/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/stumble/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/godigg/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/digg/tctechcrunch.wordpress.com/238571/\" /></a> <a rel=\"nofollow\" href=\"http://feeds.wordpress.com/1.0/goreddit/tctechcrunch.wordpress.com/238571/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/reddit/tctechcrunch.wordpress.com/238571/\" /></a> <img alt=\"\" border=\"0\" src=\"http://stats.wordpress.com/b.gif?host=techcrunch.com&amp;blog=11718616&amp;post=238571&amp;subd=tctechcrunch&amp;ref=&amp;feed=1\" width=\"1\" height=\"1\" /> <p><a href=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/0/da\"><img src=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/0/di\" border=\"0\" ismap=\"true\"></img></a><br/> <a href=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/1/da\"><img src=\"http://feedads.g.doubleclick.net/~at/w3bq_Lf15MuCCqeCkVfh9eMYs7g/1/di\" border=\"0\" ismap=\"true\"></img></a></p><div class=\"feedflare\"> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:2mJPEYqXBVI\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=2mJPEYqXBVI\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:7Q72WNTAKBA\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=7Q72WNTAKBA\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:yIl2AUoC8zA\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=yIl2AUoC8zA\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:-BTjWOF_DHI\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?i=tEFtaTZo8jI:MRP7yJsevfA:-BTjWOF_DHI\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:D7DqB2pKExk\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?i=tEFtaTZo8jI:MRP7yJsevfA:D7DqB2pKExk\" border=\"0\"></img></a> <a href=\"http://feeds.feedburner.com/~ff/Techcrunch?a=tEFtaTZo8jI:MRP7yJsevfA:qj6IDK7rITs\"><img src=\"http://feeds.feedburner.com/~ff/Techcrunch?d=qj6IDK7rITs\" border=\"0\"></img></a> </div><img src=\"http://feeds.feedburner.com/~r/Techcrunch/~4/tEFtaTZo8jI\" height=\"1\" width=\"1\"/>"})

(def bad-tc-fixed
     (merge bad-tc
	    {:des
	     "Computer power management software company, 1E has released a new version of its marquee product, NightWatchman. Like its predecessors, version 6.0, helps corporations manage their network of computers to optimize energy efficiency. It gives IT managers the ability to remotely power down computers and establish energy-saving settings (ie."}))

(deftest des-tests
  (is (= bad-tc-fixed
	 (with-des bad-tc)))
  (is (= good-tc
	 (with-des good-tc))))

(deftest date-parsing
  ;; Ensure that the datetime key strings are canonicalized to the
  ;; respective datetime value string.

  (let [datetimes {"2010-11-01T15:03:12.760Z" "2010-11-01T15:03:12.760Z",
		   "Sun, 31 Oct 2010 03:03:00 EDT" "2010-10-31T07:03:00.000Z",
		   "Sun, 31 Oct 10 03:03:00 EDT" "2010-10-31T07:03:00.000Z",
		   "Mon, 1 Nov 2010 12:24:00 PDT" "2010-11-01T19:24:00.000Z",
		   "Mon, 01 Nov 2010 12:24:00 PDT" "2010-11-01T19:24:00.000Z",
		   "1996-12-19T16:39:57-08:00" "1996-12-20T00:39:57.000Z"}]
    (doseq [[dt canonical-dt] datetimes]
      (is (= canonical-dt (@#'webmine.feeds/compact-date-time dt))))))

(def rolling-stone
"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<rss version=\"2.0\" xmlns:content=\"http://purl.org/rss/1.0/modules/content/\"\r\n\txmlns:wfw=\"http://wellformedweb.org/CommentAPI/\"\r\n\txmlns:dc=\"http://purl.org/dc/elements/1.1/\"\r\n\txmlns:atom=\"http://www.w3.org/2005/Atom\"\r\n\txmlns:sy=\"http://purl.org/rss/1.0/modules/syndication/\"\r\n\txmlns:slash=\"http://purl.org/rss/1.0/modules/slash/\"\r\n\t>\r\n<channel>\r\n\t\t<!-- cache:include src=\"http://www.rollingstone.com/cms/site/rollingstone/home?ctnid=0&cacheKey=_ctnListName_rss_allContentFeed_Cache_siteKey_rollingstone\" --><title><![CDATA[RollingStone.com: Latest News \t]]></title>\r\n        <link>http://www.rollingstone.com/home/search?cat=News</link>\r\n\t\t<description>News stories from Rolling Stone</description>\r\n\t\t<ttl>60</ttl>\r\n\t\t<language>en-us</language>\r\n\t\t<lastBuildDate>Nov, 13 2010 16:44:11 EST</lastBuildDate>\r\n\t\t<copyright>&#xA9; Copyright 2010 Rolling Stone</copyright>\r\n\t\t\r\n\t\t\n<item>\r\n\t\t\t<title><![CDATA[Jackson Browne, Patti Smith, Others Celebrate Lennon]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233947</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[\"I feel like I just went to Beatles camp,\" Jackson Browne, who had just finished performing at the Theater Within 30th Annual John Lennon tribute concert Friday night, told Rolling Stone. He was sitting in his sixth-floor dressing room after having played a faithful, laid-back \"You've Got to Hide Your ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233947]]></guid>\r\n\t\t\t<pubDate>Nov, 13 2010 13:13:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[The Week In Music: Conflict — and Triumph]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233903</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[This week, the world of music was battered by conflict. • A Swedish journalist said Keith Richards smacked him — but a Richards rep told us that wasn't true. • Lil' Kim bashed Nicki Minaj • Kurt swung back at the bully on Glee. • Kanye West raged against Matt ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233903]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 17:38:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Guns N' Roses Planning 'Chinese Democracy' Follow-Up]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233892</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Guns N' Roses' follow-up to their 2008 release Chinese Democracy might already be in the planning stages. At least that's what guitarist DJ Ashba, a member of the band since 2009, told the wire service Artisan News Service at a recent red-carpet event in California. \"We're talking about that right ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233892]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 17:28:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Watch: Exclusive Clip From 'Kid Rock: Born Free']]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233879</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Tuesday marks the release of Born Free, Kid Rock's eighth studio abum and first since 2007's triple-platinum Rock N' Roll Jesus. The Rick Rubin-produced album contains cameos by Zac Brown, T.I., Martina McBride, Bob Seger and Sheryl Crow. Rock told Rolling Stone that the album was \"focused on great songs, ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233879]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 16:55:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Michael Jackson's 'Michael' Projected to Sell 400,000 Copies In First Week]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233872</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Sony Music Entertainment, which is distributing the first the first posthumous album from Michael Jackson, is expecting big numbers from the Epic Records release Michael when it hits stores on December 14. Billboard reports that the company will ship 900,000 copies of the album to retailers around the country, and ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233872]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 16:53:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Viacom To Sell 'Rock Band' Manufacturer Harmonix]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233796</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Viacom announced on Thursday that it was selling Harmonix, the Cambridge, Mass.-based company that currently develops and manufactures the Rock Band series of music games and was the original developer of Guitar Hero. \"Our decision to exit this business strategy is to focus on what we do best, and that's ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233796]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 14:08:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Paul McCartney Delights Crowds In Buenos Aires]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233789</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Paul McCartney played the second of two sold-out shows at Estadio Antonio Vespucio Liberti (River Plate Stadium) in Buenos Aires on Thursday night, part of the South American leg of McCartney's Up and Coming Tour. According to Pablo Toledo of the English-language daily the Buenos Aires Herald, McCartney's three-hour, 35-track ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233789]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 13:38:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Rolling Stone Hackers Article Headed to Big Screen]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233785</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Alessandro Camon (who shared an Oscar nomination for scripting The Messenger) will adapt the June 10, 2010 Rolling Stone article \"Hackers Gone Wild: The Fast Times and Hard Fall of the Green Hat Gang\". In the piece, writer Sabrina Rubin Erdely uncovered the story of computer hacker Albert Gonzalez, who ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233785]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 13:34:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Watch Bruce Springsteen Play 'Mustang Sally' With a Jersey Bar Band]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233718</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Thursday night Bruce Springsteen stunned fans at Woody's Roadside Tavern in Farmingdale, N.J. when he joined local band Timepiece (which includes his brother in-law Mike Scialfa) for a cover of Wilson Pickett's \"Mustang Sally.\" In front of an overjoyed small group of fans holding cell-phone cameras, Springsteen traded vocals and ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233718]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 12:48:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Watch: Gwyneth Paltrow Takes On Cee Lo in Her 'Glee' Debut]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233701</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Just two days after wowing the crowd at the Country Music Awards with a performance of the title track for her upcoming movie Country Strong, Gwyneth Paltrow debuts her pop chops with a cover of Cee Lo's \"F--k You\" from next week's Glee. In the clip, which EW.com premiered this ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233701]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 11:39:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Taylor Swift, Miley Cyrus Join American Music Awards Lineup]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233605</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Taylor Swift, Miley Cyrus and Kid Rock will perform on this year's American Music Awards on November 21, it was announced during the CMA Awards Wednesday night. The three join previously announced performers Justin Bieber, Katy Perry, Ke$ha, Christina Aguilera, Bon Jovi, NKOTBSB (a.k.a. New Kids on the Block with ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233605]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 09:50:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Michael Jackson Disc to Feature Akon, Lenny Kravitz]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233602</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Early Friday morning, Michael Jackson's website released the tracklisting for Michael, the first album to be released after the pop icon's June 2009 death. The album, which hits stores December 14, will be teased by the single \"Hold My Hand,\" a collaboration with the \"Smack That\" singer Akon. \"Hold My ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233602]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 09:17:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Kanye West Attacks 'Today' On Twitter]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233608</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[While getting ready to perform in Abu Dhabi on Friday, Kanye West took to his Twitter account to discuss the reaction to his heated appearance on NBC's Today on Wednesday morning — and to refute Matt Lauer's announcement on Thursday morning that West would perform on the show later this ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233608]]></guid>\r\n\t\t\t<pubDate>Nov, 12 2010 09:02:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Sex, Drugs, and the Biggest Cybercrime of All Time]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/culture/news/17389/233391</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[The following is an article from the June 10, 2010 issue of Rolling Stone. This issue is available online in Rolling Stone’s digital archive. Click here to subscribe. They'd been high all weekend long — on Ecstasy, coke, mushrooms and acid — so there seemed little harm in doing one ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/culture/news/17389/233391]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 18:01:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[New Gorillaz Disc, Made on an iPad, May Be Out by Christmas]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233253</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Gorillaz, who released their Plastic Beach LP just a few months ago, could have another disc out by Christmas. Said Damon Albarn, who just completed a North American tour with the group, to NME: \"I've been recording a new record on the road, which I'm going to try and put ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233253]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 17:30:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Rolling Stone's First Issue: An Anniversary Flashback]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233249</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Forty-three years ago this week, the first issue of Rolling Stone hit stands. \"You're probably wondering what we are trying to do,\" founder, editor and publisher Jann Wenner wrote in the first editor's note. \"It's hard to say: sort of a magazine and sort of a newspaper. The name of ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233249]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 17:26:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Exclusive: Hear J. Cole's New Song With Drake, 'In the Morning']]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233246</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[J. Cole - In The Morning feat. Drake (Prod. by L&X Music) by JCOLE Listen exclusively here to the J. Cole, Drake collaboration \"In the Morning,\" off J.'s new mixtape, Friday Night Lights, which comes out Friday. The Jay-Z protégé has been building a solid rep over the past three ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233246]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 17:20:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Lil Wayne to Release Brand-New Song Right Away]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233202</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Just one week after being released from prison, Lil Wayne has already finished a new song and is ready to put it out. \"We're trying to put it out, like, tomorrow,\" Cortez Bryant, Wayne's manager, told Rolling Stone. \"We got a crazy song. If not tomorrow, definitely next week.\" Photos: ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233202]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 16:37:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[How Buffalo Springfield Could Pull Off a Tour With the Byrds]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233136</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Word is that Buffalo Springfield will tour next year. But how exactly would that work? Neil Young, Crosby, Stills and Nash can command arenas and ampitheaters on their own, but Springfield can claim only one top forty hit, \"For What It's Worth.\" It's hard to see them in anything bigger ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233136]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 15:26:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Sheffield: How 'Glee' Became a Pop-Culture Juggernaut]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/culture/news/17389/233161</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[The following is an article from the November 25, 2010 issue of Rolling Stone. This issue is available Friday on newsstands, as well online in Rolling Stone’s digital archive. Click here to subscribe. Many people predicted Glee would run out of gas after the novelty wore off. But these people ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/culture/news/17389/233161]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 15:25:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Plus: Singer Vs. Rick Ross; Ping Plus Twitter]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233704</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Chrisette Michele vs. Rick Ross R&B singer Chrisette Michele wrote a frustrated post on her blog after rapper Rick Ross ditched out on a performance of their single \"Aston Martin Music\" at the Soul Train Awards Wednesday night. Ross left the awards show early after losing the Best Hip-Hop Song ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233704]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 15:10:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Rolling Stone Live: Austin Psych-Rockers Black Angels]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233130</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[With their lysergic grooves and hilarious twists on iconic rock titles (\"Bad Vibrations,\" \"Sniper at the Gates of Heaven\"), the Austin, Texas fivesome Black Angels are one of the best psych-rock groups going. (They were recently named Rolling Stone's Band of the Week.) This intimate, stripped-down set is still plenty ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233130]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 15:04:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Gwyneth Paltrow: Beyonce Helped Me Prepare for CMAs]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233127</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Before she made her live singing debut on Wednesday's CMAs, Gwyneth Paltrow relied on few friends in high places for pointers. \"I kind of asked my girl singer friends [for advice],\" she told Access Hollywood before belting out the title track to her new drama, Country Strong. \"I asked Faith ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233127]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 14:55:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Watch: More From Kanye West's 'Brutal' Interview on 'Today']]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233058</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[The Today show shot back at Kanye West Thursday morning, airing extended segments from its taped interview Wednesday that West described as \"brutal.\" West claimed that interviewer Matt Lauer had \"tried to force my answers,\" but the newly released clips show West getting increasingly testy while Lauer is persistent in ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233058]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 12:36:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<item>\r\n\t\t\t<title><![CDATA[Video: Gwyneth Paltrow Performs At CMAs]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233045</link>\r\n\t\t\t<icon>/favicon.ico</icon>\r\n\t\t\t<content:encoded><![CDATA[Last night's Country Music Awards featured performances by George Strait, Rascal Flatts and Kenny Chesney — but it was Gwyneth Paltrow who left the biggest impression on the audience. Playing the title track to her forthcoming film Country Song, the actress sounded like an old Nashville pro and drew a ...]]></content:encoded>\r\n\t\t\t<guid isPermaLink=\"false\"><![CDATA[http://www.rollingstone.com/music/news/51942/233045]]></guid>\r\n\t\t\t<pubDate>Nov, 11 2010 11:57:00 EST</pubDate>\r\n\t\t\t</item>\r\n\t<!-- /cache:include -->\n</channel>\r\n</rss>\r\n\r\n")

(def rolling-stone-sans-title
"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<rss version=\"2.0\" xmlns:content=\"http://purl.org/rss/1.0/modules/content/\"\r\n\txmlns:wfw=\"http://wellformedweb.org/CommentAPI/\"\r\n\txmlns:dc=\"http://purl.org/dc/elements/1.1/\"\r\n\txmlns:atom=\"http://www.w3.org/2005/Atom\"\r\n\txmlns:sy=\"http://purl.org/rss/1.0/modules/syndication/\"\r\n\txmlns:slash=\"http://purl.org/rss/1.0/modules/slash/\"\r\n\t>\r\n<channel>\r\n\t\t<!-- cache:include src=\"http://www.rollingstone.com/cms/site/rollingstone/home?ctnid=0&cacheKey=_ctnListName_rss_allContentFeed_Cache_siteKey_rollingstone\" --><link>http://www.rollingstone.com/home/search?cat=News</link>\r\n\t\t<description>News stories from Rolling Stone</description>\r\n\t\t<ttl>60</ttl>\r\n\t\t<language>en-us</language>\r\n\t\t<lastBuildDate>Nov, 13 2010 16:44:11 EST</lastBuildDate>\r\n\t\t<copyright>&#xA9; Copyright 2010 Rolling Stone</copyright>\r\n\t\t\r\n\t\t\n<item>\r\n\t\t\t<title><![CDATA[Jackson Browne, Patti Smith, Others Celebrate Lennon]]></title>\r\n\t\t\t<link>http://www.rollingstone.com/music/news/51942/233947</link></item></channel></rss>")

(deftest parse-entries
  (is (= 25 (count (extract-entries rolling-stone)))))  

(deftest complete-title
  (is (= "RollingStone.com: Latest News "
	 (:title (parse-feed rolling-stone))))
  (is (= "www.rollingstone.com"
	 (:title (parse-feed rolling-stone-sans-title)))))

(deftest sentences
  (is (= "hello thomas. baz. bar."
	 (first-k-sentences "hello thomas. baz. bar. bang." 3)))
  (is (=  "hello thomas."
	  (first-k-sentences "hello thomas. baz. bar. bang." 1)))
  (is (= "hello thomas@gmail.com."
	 (first-k-sentences "hello thomas@gmail.com. baz. bar. bang." 1))))



;; http://www.usatoday.com/news/nation/2011-01-31-students31_ST_N.htm
;; http://blog.kissmetrics.com/beginners-guide-to-landing-pages/
;; http://www.latimes.com/news/nationworld/world/la-fg-muslim-brotherhood-20110131,0,5283199.story